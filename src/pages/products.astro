---
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';
import { Image } from 'astro:assets';
import { products } from '../data/products';

// Preload critical images for faster navigation
const preloadImages = products.flatMap(product => 
  product.images.slice(0, 2).map(img => img.src)
);
---

<Layout title="Products - Kids Kreations">
  <!-- Preload critical images for faster navigation -->
  {preloadImages.map(src => (
    <link rel="preload" as="image" href={src} />
  ))}
  
  <Navigation />
  
  <main>
    <section class="hero product-hero">
      <div class="container">
        <div class="section-title">
          <h1>Explore Our Infantwear Collection</h1>
          <p>Flexible MOQs, GOTS-certified materials, custom packaging, and export-ready babywear.</p>
        </div>
      </div>
    </section>

    <section class="products">
      <div class="container">
        <div class="products-grid">
          {products.map((product, productIndex) => (
            <article class="product-card" data-orientation={product.orientation} data-slug={product.slug}>
              <div class="product-image-wrapper">
                {product.images && product.images.length > 0 && (
                  <div class="product-gallery">
                    {product.images.map((image, imageIndex) => (
                      <Image 
                        src={image} 
                        alt={`${product.title} - View ${imageIndex + 1}`}
                        class="product-image"
                        loading={productIndex < 3 ? (imageIndex < 2 ? 'eager' : 'lazy') : 'lazy'}
                        decoding="async"
                        style={`display: ${imageIndex === 0 ? 'block' : 'none'}`}
                        width={600}
                        height={450}
                        quality={85}
                        format="webp"
                      />
                    ))}
                    <button class="gallery-nav gallery-prev" aria-label="Previous image">‚Üê</button>
                    <button class="gallery-nav gallery-next" aria-label="Next image">‚Üí</button>
                    <div class="gallery-dots">
                      {product.images.map((_, imageIndex) => (
                        <button 
                          class="gallery-dot" 
                          aria-label={`View image ${imageIndex + 1}`}
                          data-index={imageIndex}
                        ></button>
                      ))}
                    </div>
                    <button class="zoom-button" aria-label="Zoom image">
                      <i class="fas fa-search-plus"></i>
                    </button>
                    <div class="loading-indicator" style="display: none;">
                      <div class="spinner"></div>
                    </div>
                  </div>
                )}
              </div>
              <div class="product-info">
                <h3 class="product-title">{product.title}</h3>
                <p class="product-description">{product.description}</p>
                <ul class="product-features">
                  {product.features.slice(0, 3).map(feature => (
                    <li class="feature-item">
                      <i class="fas fa-check"></i>
                      <span>{feature}</span>
                    </li>
                  ))}
                  {product.features.length > 3 && (
                    <li class="feature-more">
                      +{product.features.length - 3} more features
                    </li>
                  )}
                </ul>
                <div class="product-badges">
                  {product.badges.slice(0, 3).map(badge => (
                    <span class={`badge ${
                      badge.includes('GOTS') || badge.includes('Organic') ? 'badge-green' :
                      badge.includes('Best') || badge.includes('Popular') ? 'badge-purple' :
                      'badge-blue'
                    }`}>
                      {badge.includes('Organic') ? 'üåø' : 
                       badge.includes('Gift') ? 'üéÅ' : 
                       badge.includes('Best') ? '‚≠ê' : ''} 
                      {badge}
                    </span>
                  ))}
                </div>
              </div>
            </article>
          ))}
        </div>
      </div>
    </section>

    <section class="cta-section">
      <div class="container">
        <div class="cta-content">
          <h2>Interested in Our Products?</h2>
          <p>Contact us to discuss your specific requirements and get a custom quote</p>
          <a href="/contact" class="button button-primary">Request Quote</a>
        </div>
      </div>
    </section>
  </main>

  <!-- Image Modal -->
  <div id="imageModal" class="image-modal" role="dialog" aria-modal="true" aria-label="Product image viewer">
    <div class="modal-content">
      <button class="modal-close" aria-label="Close modal">√ó</button>
      <button class="modal-nav modal-prev" aria-label="Previous image">‚Üê</button>
      <button class="modal-nav modal-next" aria-label="Next image">‚Üí</button>
      <div class="modal-image-container">
        <img 
          id="modalImage" 
          src="" 
          alt="Product image"
          class="modal-image"
          loading="lazy"
          decoding="async"
        />
      </div>
    </div>
  </div>

  <Footer />
</Layout>

<style>
  .product-hero {
    background: linear-gradient(to right, var(--primary-light), var(--background));
    padding: var(--spacing-xl) 0;
    text-align: center;
  }

  .section-title {
    max-width: 800px;
    margin: 0 auto;
  }

  .section-title h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 2.5rem;
    margin-bottom: var(--spacing-sm);
  }

  .products {
    padding: var(--spacing-xl) 0;
    background: var(--background);
  }

  .products-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-lg);
    max-width: 1400px;
    margin: 0 auto;
  }

  .product-card {
    background: white;
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: all 0.3s ease;
    height: 100%;
    box-shadow: var(--shadow-sm);
    display: flex;
    flex-direction: column;
    animation: fadeIn 0.5s ease-out;
    cursor: pointer;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .product-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }

  .product-image-wrapper {
    position: relative;
    overflow: hidden;
    background: #f8f8f8;
    aspect-ratio: var(--aspect-ratio);
  }

  .product-card[data-orientation="portrait"] {
    --aspect-ratio: 3/4;
  }

  .product-card[data-orientation="landscape"] {
    --aspect-ratio: 4/3;
  }

  .product-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  .product-card:hover .product-image {
    transform: scale(1.05);
  }

  .loading-indicator {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 30;
  }

  .spinner {
    width: 24px;
    height: 24px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top: 2px solid var(--primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .product-info {
    padding: var(--spacing-md);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    flex: 1;
  }

  .product-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-dark);
    margin: 0;
    line-height: 1.4;
  }

  .product-description {
    color: var(--text-light);
    font-size: 0.95rem;
    line-height: 1.5;
    margin: 0;
    min-height: 57px; /* Fallback for ~3 lines */
  }

  .product-features {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .feature-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-light);
  }

  .feature-item i {
    color: var(--primary);
    font-size: 0.75rem;
  }

  .feature-more {
    font-size: 0.875rem;
    margin-top: 0.25rem;
    color: var(--primary);
    font-weight: 500;
  }

  .product-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: auto;
    padding-top: var(--spacing-sm);
  }

  .badge {
    padding: 0.25rem 0.75rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    white-space: nowrap;
  }

  .badge-blue {
    background: #EEF2FF;
    color: #4F46E5;
  }

  .badge-green {
    background: #ECFDF5;
    color: #059669;
  }

  .badge-purple {
    background: #F5F3FF;
    color: #7C3AED;
  }

  .zoom-button {
    position: absolute;
    top: var(--spacing-sm);
    right: var(--spacing-sm);
    background: rgba(255, 255, 255, 0.9);
    border: none;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 20;
    backdrop-filter: blur(4px);
    opacity: 0;
  }

  .product-card:hover .zoom-button {
    opacity: 1;
  }

  .zoom-button:hover {
    background: var(--primary);
    color: white;
    transform: scale(1.1);
  }

  .gallery-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.8);
    border: none;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    cursor: pointer;
    color: var(--text-dark);
    transition: all 0.3s ease;
    z-index: 20;
    opacity: 0;
    backdrop-filter: blur(4px);
  }

  .gallery-prev {
    left: 8px;
  }

  .gallery-next {
    right: 8px;
  }

  .product-card:hover .gallery-nav {
    opacity: 1;
  }

  .gallery-nav:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-50%) scale(1.1);
  }

  .gallery-dots {
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 4px;
    z-index: 20;
    background: rgba(255, 255, 255, 0.5);
    padding: 4px 8px;
    border-radius: var(--radius-full);
    backdrop-filter: blur(4px);
  }

  .gallery-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.3);
    border: none;
    padding: 0;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .gallery-dot.active {
    background: var(--primary);
    transform: scale(1.2);
  }

  @media (max-width: 1200px) {
    .products-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .products-grid {
      grid-template-columns: 1fr;
    }

    .product-card {
      max-width: 500px;
      margin: 0 auto;
    }

    .gallery-nav {
      display: none;
    }
  }

  .image-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .image-modal.active {
    display: flex;
    opacity: 1;
  }

  .modal-content {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-xl);
  }

  .modal-image-container {
    max-width: 90vw;
    max-height: 90vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-image {
    max-width: 100%;
    max-height: 90vh;
    object-fit: contain;
    border-radius: var(--radius-lg);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  }

  .modal-close {
    position: absolute;
    top: var(--spacing-lg);
    right: var(--spacing-lg);
    background: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-dark);
    transition: all 0.3s ease;
    z-index: 1001;
  }

  .modal-close:hover {
    background: var(--primary);
    color: white;
    transform: scale(1.1);
  }

  .modal-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.9);
    border: none;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-dark);
    transition: all 0.3s ease;
    z-index: 1001;
    backdrop-filter: blur(4px);
  }

  .modal-prev {
    left: var(--spacing-lg);
  }

  .modal-next {
    right: var(--spacing-lg);
  }

  .modal-nav:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-50%) scale(1.1);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize image galleries with optimized loading
    document.querySelectorAll('.product-gallery').forEach(gallery => {
      const images = Array.from((gallery as HTMLElement).querySelectorAll<HTMLImageElement>('.product-image'));
      const dots = Array.from((gallery as HTMLElement).querySelectorAll<HTMLButtonElement>('.gallery-dot'));
      const prevBtn = (gallery as HTMLElement).querySelector<HTMLButtonElement>('.gallery-prev');
      const nextBtn = (gallery as HTMLElement).querySelector<HTMLButtonElement>('.gallery-next');
      const zoomBtn = (gallery as HTMLElement).querySelector<HTMLButtonElement>('.zoom-button');
      const loadingIndicator = (gallery as HTMLElement).querySelector<HTMLElement>('.loading-indicator');
      let currentIndex = 0;

      // Swipe functionality for mobile
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;

      gallery.addEventListener('touchstart', (event: TouchEvent) => {
        touchStartX = event.changedTouches[0].screenX;
        touchStartY = event.changedTouches[0].screenY;
      }, { passive: true });

      gallery.addEventListener('touchend', (event: TouchEvent) => {
        touchEndX = event.changedTouches[0].screenX;
        touchEndY = event.changedTouches[0].screenY;
        handleSwipe();
      }, { passive: true });

      function handleSwipe() {
        const swipeThreshold = 50; // Minimum distance for a swipe
        const deltaX = touchEndX - touchStartX;
        const deltaY = touchEndY - touchStartY;

        // Check if it's a horizontal swipe and not a vertical scroll
        if (Math.abs(deltaX) > Math.abs(deltaY)) {
          if (deltaX < -swipeThreshold) {
            // Swiped left
            const newIndex = (currentIndex + 1) % images.length;
            showImage(newIndex);
          } else if (deltaX > swipeThreshold) {
            // Swiped right
            const newIndex = (currentIndex - 1 + images.length) % images.length;
            showImage(newIndex);
          }
        }
      }

      // Preload next and previous images for faster navigation
      function preloadAdjacentImages() {
        const nextIndex = (currentIndex + 1) % images.length;
        const prevIndex = (currentIndex - 1 + images.length) % images.length;
        
        // Preload next image
        if (images[nextIndex] && !images[nextIndex].complete) {
          const nextImg = new window.Image();
          nextImg.src = images[nextIndex].src;
        }
        
        // Preload previous image
        if (images[prevIndex] && !images[prevIndex].complete) {
          const prevImg = new window.Image();
          prevImg.src = images[prevIndex].src;
        }
      }

      function showImage(index: number) {
        // Show loading indicator
        if (loadingIndicator) {
          loadingIndicator.style.display = 'flex';
        }

        // Hide all images
        images.forEach(img => {
          img.style.display = 'none';
          img.style.opacity = '0';
        });
        
        // Update dots
        dots.forEach(dot => {
          dot.classList.remove('active');
        });
        
        // Show target image
        const targetImage = images[index];
        if (!targetImage) return;

        targetImage.style.display = 'block';
        
        // Check if image is already loaded
        if (targetImage.complete && targetImage.naturalHeight !== 0) {
          targetImage.style.opacity = '1';
          if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
          }
        } else {
          // Wait for image to load
          targetImage.onload = () => {
            targetImage.style.opacity = '1';
            if (loadingIndicator) {
              loadingIndicator.style.display = 'none';
            }
          };
          
          // Fallback in case onload doesn't fire
          setTimeout(() => {
            targetImage.style.opacity = '1';
            if (loadingIndicator) {
              loadingIndicator.style.display = 'none';
            }
          }, 1000);
        }
        
        if (dots[index]) {
          dots[index].classList.add('active');
        }
        currentIndex = index;
        
        // Preload adjacent images for next navigation
        setTimeout(preloadAdjacentImages, 100);
      }

      if (prevBtn) {
        prevBtn.onclick = (e: MouseEvent) => {
          e.preventDefault();
          e.stopPropagation();
          const newIndex = (currentIndex - 1 + images.length) % images.length;
          showImage(newIndex);
        };
      }

      if (nextBtn) {
        nextBtn.onclick = (e: MouseEvent) => {
          e.preventDefault();
          e.stopPropagation();
          const newIndex = (currentIndex + 1) % images.length;
          showImage(newIndex);
        };
      }

      dots.forEach((dot, index) => {
        dot.onclick = (e: MouseEvent) => {
          e.preventDefault();
          e.stopPropagation();
          showImage(index);
        };
      });

      if (zoomBtn) {
        zoomBtn.onclick = (e: MouseEvent) => {
          e.preventDefault();
          e.stopPropagation();
          if (images[currentIndex]) {
            openModal(images[currentIndex].src, gallery as HTMLElement, currentIndex);
          }
        };
      }

      // Initialize first image
      showImage(0);
    });

    // Make product cards clickable
    document.querySelectorAll<HTMLElement>('.product-card').forEach(card => {
      card.addEventListener('click', (e) => {
        // Don't navigate if a button or an element within the gallery controls was clicked
        if ((e.target as HTMLElement).closest('button')) {
          return;
        }

        const slug = card.dataset.slug;
        if (slug) {
          window.location.href = `/products/${slug}`;
        }
      });
    });

    // Modal functionality
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage') as HTMLImageElement | null;
    const closeBtn = document.querySelector('.modal-close');
    const modalPrevBtn = document.querySelector('.modal-prev');
    const modalNextBtn = document.querySelector('.modal-next');
    
    let currentGallery: HTMLElement | null = null;
    let currentImageIndex = 0;
    
    function openModal(imageSrc: string, gallery: HTMLElement, index: number) {
      if (!modal || !modalImg) return;
      modalImg.src = imageSrc;
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
      currentGallery = gallery;
      currentImageIndex = index;
      updateNavigationButtons();
      
      // Trap focus within modal
      modal.focus();
    }
    
    function closeModal() {
      if (!modal) return;
      modal.classList.remove('active');
      document.body.style.overflow = '';
      currentGallery = null;
    }

    function showNextImage() {
      if (!currentGallery || !modalImg) return;
      const images = currentGallery.querySelectorAll<HTMLImageElement>('.product-image');
      currentImageIndex = (currentImageIndex + 1) % images.length;
      if (images[currentImageIndex]) {
        modalImg.src = images[currentImageIndex].src;
      }
      updateNavigationButtons();
    }

    function showPrevImage() {
      if (!currentGallery || !modalImg) return;
      const images = currentGallery.querySelectorAll<HTMLImageElement>('.product-image');
      currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
      if (images[currentImageIndex]) {
        modalImg.src = images[currentImageIndex].src;
      }
      updateNavigationButtons();
    }

    function updateNavigationButtons() {
      if (!currentGallery || !modalPrevBtn || !modalNextBtn) return;
      const images = currentGallery.querySelectorAll('.product-image');
      (modalPrevBtn as HTMLElement).style.display = images.length > 1 ? 'flex' : 'none';
      (modalNextBtn as HTMLElement).style.display = images.length > 1 ? 'flex' : 'none';
    }
    
    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
    }
    
    if (modalPrevBtn) modalPrevBtn.addEventListener('click', showPrevImage);
    if (modalNextBtn) modalNextBtn.addEventListener('click', showNextImage);
    
    document.addEventListener('keydown', (e) => {
      if (!modal || !modal.classList.contains('active')) return;
      
      switch(e.key) {
        case 'Escape':
          closeModal();
          break;
        case 'ArrowLeft':
          showPrevImage();
          break;
        case 'ArrowRight':
          showNextImage();
          break;
      }
    });
  });
</script> 